{{define "speciesSettings"}}

<!-- Include Species Section -->
<div class="collapse collapse-open bg-base-100 shadow-xs col-span-3" x-data="{ 
    speciesSettings: {
        Include: {{if .Settings.Realtime.Species.Include}}{{.Settings.Realtime.Species.Include | toJSON}}{{else}}[]{{end}},
    },
    newIncludeSpecies: '',
    showTooltip: null,
    hasChanges: false,
    predictions: [],
    allSpecies: {{getAllSpecies | toJSON}},
    includeSpeciesOpen: false,
    
    addSpecies(list) {
        const newSpecies = this['new' + list + 'Species'].trim();
        if (newSpecies && !this.speciesSettings[list].includes(newSpecies)) {
            this.speciesSettings[list].push(newSpecies);
            this['new' + list + 'Species'] = '';
            this.hasChanges = true;
        }
    },
    removeSpecies(list, species) {
        this.speciesSettings[list] = this.speciesSettings[list].filter(s => s !== species);
        this.hasChanges = true;
    },
    updatePredictions(input) {
        if (!input) {
            this.predictions = [];
            return;
        }
        this.predictions = this.allSpecies
            .filter(species => 
                species.toLowerCase().includes(input.toLowerCase())
            )
            .slice(0, 5);
    }
}" x-init="$watch('speciesSettings.Include', () => { hasChanges = true }, { deep: true });">
    <input type="checkbox" id="includeSpeciesOpen" x-on:change="includeSpeciesOpen = !includeSpeciesOpen" />
    <div class="collapse-title text-xl font-medium">
        <div class="flex items-center">
            <label for="includeSpeciesOpen" class="cursor-pointer">Always Include Species</label>
            <div class="ml-2" x-show="hasChanges" x-cloak>
                <span class="badge badge-primary badge-sm changed-badge">
                    <span class="text-xs mb-0.5">changed</span>
                </span>
            </div>
        </div>
        <p class="text-sm text-gray-500">Species in this list will always be included in detection.</p>
    </div>
    <div class="collapse-content">
        <!-- Include species list and input -->
        <div class="form-control relative mt-4">
            <label class="label-text">
                Always Include Species
                <span class="ml-2 text-sm text-gray-500 cursor-help"
                      @mouseenter="showTooltip = 'Include'"
                      @mouseleave="showTooltip = null">ⓘ</span>
            </label>

            <div class="absolute left-0 bottom-full mb-2 p-2 bg-gray-100 text-sm rounded shadow-md z-50"
                 x-show="showTooltip === 'Include'" x-cloak>
                Species in this list will always be included in detection, regardless of range filter settings.
            </div>

            <!-- Include species list -->
            <div class="space-y-2">
                <template x-for="(species, index) in speciesSettings.Include" :key="index">
                    <div class="flex items-center bg-gray-50 space-x-2 p-2 rounded-md">
                        <div class="flex-grow">
                            <span x-text="species" class="text-sm"></span>
                        </div>
                        <div class="flex-shrink-0">
                            <button type="button" @click="removeSpecies('Include', species)" 
                                    class="btn btn-xs">Remove</button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Include species input -->
            <div class="flex items-center mt-2">
                <input type="text" 
                       x-model="newIncludeSpecies" 
                       @input="updatePredictions(newIncludeSpecies)" 
                       list="species-suggestions"
                       placeholder="Add species to include" 
                       class="input input-bordered input-sm w-full" />
                <datalist id="species-suggestions">
                    <template x-for="species in predictions" :key="species">
                        <option :value="species"></option>
                    </template>
                </datalist>
                <button type="button" @click="addSpecies('Include')" class="btn btn-sm btn-primary ml-2 mr-2 w-20">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- Exclude Species Section -->
<div class="collapse collapse-open bg-base-100 shadow-xs col-span-3" x-data="{ 
    speciesSettings: {
        Exclude: {{if .Settings.Realtime.Species.Exclude}}{{.Settings.Realtime.Species.Exclude | toJSON}}{{else}}[]{{end}},
    },
    newExcludeSpecies: '',
    showTooltip: null,
    hasChanges: false,
    predictions: [],
    filteredSpecies: {{getIncludedSpecies | toJSON}},
    excludeSpeciesOpen: false,
    
    addSpecies(list) {
        const newSpecies = this['new' + list + 'Species'].trim();
        if (newSpecies && !this.speciesSettings[list].includes(newSpecies)) {
            this.speciesSettings[list].push(newSpecies);
            this['new' + list + 'Species'] = '';
            this.hasChanges = true;
        }
    },
    removeSpecies(list, species) {
        this.speciesSettings[list] = this.speciesSettings[list].filter(s => s !== species);
        this.hasChanges = true;
    },
    updatePredictions(input) {
        if (!input) {
            this.predictions = [];
            return;
        }
        this.predictions = this.filteredSpecies
            .filter(species => 
                species.toLowerCase().includes(input.toLowerCase())
            )
            .slice(0, 5);
    }
}" x-init="$watch('speciesSettings.Exclude', () => { hasChanges = true }, { deep: true });">
    <input type="checkbox" id="excludeSpeciesOpen" x-on:change="excludeSpeciesOpen = !excludeSpeciesOpen" />
    <div class="collapse-title text-xl font-medium">
        <div class="flex items-center">
            <label for="excludeSpeciesOpen" class="cursor-pointer">Always Exclude Species</label>
            <div class="ml-2" x-show="hasChanges" x-cloak>
                <span class="badge badge-primary badge-sm changed-badge">
                    <span class="text-xs mb-0.5">changed</span>
                </span>
            </div>
        </div>
        <p class="text-sm text-gray-500">Species in this list will always be excluded from detection.</p>
    </div>
    <div class="collapse-content">
        <!-- Exclude species list and input -->
        <div class="form-control relative mt-4">
            <label class="label-text">
                Always Exclude Species
                <span class="ml-2 text-sm text-gray-500 cursor-help"
                      @mouseenter="showTooltip = 'Exclude'"
                      @mouseleave="showTooltip = null">ⓘ</span>
            </label>

            <div class="absolute left-0 bottom-full mb-2 p-2 bg-gray-100 text-sm rounded shadow-md z-50"
                 x-show="showTooltip === 'Exclude'" x-cloak>
                Species in this list will always be excluded from detection, regardless of range filter settings.
            </div>

            <!-- Exclude species list -->
            <div class="space-y-2">
                <template x-for="(species, index) in speciesSettings.Exclude" :key="index">
                    <div class="flex items-center bg-gray-50 space-x-2 p-2 rounded-md">
                        <div class="flex-grow">
                            <span x-text="species" class="text-sm"></span>
                        </div>
                        <div class="flex-shrink-0">
                            <button type="button" @click="removeSpecies('Exclude', species)" 
                                    class="btn btn-xs">Remove</button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Exclude species input -->
            <div class="flex items-center mt-2">
                <input type="text" 
                       x-model="newExcludeSpecies" 
                       @input="updatePredictions(newExcludeSpecies)" 
                       list="species-suggestions"
                       placeholder="Add species to exclude" 
                       class="input input-bordered input-sm w-full" />
                <datalist id="species-suggestions">
                    <template x-for="species in predictions" :key="species">
                        <option :value="species"></option>
                    </template>
                </datalist>
                <button type="button" @click="addSpecies('Exclude')" class="btn btn-sm btn-primary ml-2 mr-2 w-20">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Species Configuration Section -->
<div class="collapse collapse-open bg-base-100 shadow-xs col-span-3" x-data="{ 
    speciesSettings: {
        Config: {{if .Settings.Realtime.Species.Config}}{{.Settings.Realtime.Species.Config | toJSON}}{{else}}{}{{end}},
    },
    newSpeciesConfig: '',
    newThreshold: 0.5,
    showTooltip: null,
    hasChanges: false,
    predictions: [],
    allSpecies: {{getAllSpecies | toJSON}},
    customConfigOpen: false,
    showActionsModal: false,
    currentSpecies: '',
    currentAction: { type: 'ExecuteCommand', command: '', parameters: '' },
    
    addConfig() {
        if (this.newSpeciesConfig && !this.speciesSettings.Config[this.newSpeciesConfig]) {
            this.speciesSettings.Config[this.newSpeciesConfig] = {
                Threshold: this.newThreshold,
                Actions: []
            };
            this.newSpeciesConfig = '';
            this.newThreshold = 0.5;
            this.hasChanges = true;
        }
    },
    removeConfig(species) {
        delete this.speciesSettings.Config[species];
        this.hasChanges = true;
    },
    openActionsModal(species) {
        this.currentSpecies = species;
        const existingAction = this.speciesSettings.Config[species]?.Actions?.[0];
        const defaultAction = { Type: 'ExecuteCommand', Command: '', Parameters: [] };
        const action = existingAction || defaultAction;
        
        this.currentAction = {
            type: action.Type,
            command: action.Command,
            parameters: Array.isArray(action.Parameters) ? action.Parameters.join(',') : ''
        };
        this.showActionsModal = true;
    },
    saveAction() {
        if (!this.speciesSettings.Config[this.currentSpecies]) {
            this.speciesSettings.Config[this.currentSpecies] = {
                Threshold: 0.5,
                Actions: []
            };
        }
        
        const newAction = {
            Type: this.currentAction.type,
            Command: this.currentAction.command,
            Parameters: this.currentAction.parameters.split(',').map(p => p.trim()).filter(p => p)
        };
        
        this.speciesSettings.Config[this.currentSpecies].Actions = [newAction];
        this.hasChanges = true;
        this.closeActionsModal();
    },
    closeActionsModal() {
        this.showActionsModal = false;
    },
    updatePredictions(input) {
        if (!input) {
            this.predictions = [];
            return;
        }
        this.predictions = this.allSpecies
            .filter(species => 
                species.toLowerCase().includes(input.toLowerCase())
            )
            .slice(0, 5);
    }
}" x-init="$watch('speciesSettings.Config', () => { hasChanges = true }, { deep: true });">
    <input type="checkbox" id="customConfigOpen" x-on:change="customConfigOpen = !customConfigOpen" />
    <div class="collapse-title text-xl font-medium">
        <div class="flex items-center">
            <label for="customConfigOpen" class="cursor-pointer">Custom Species Configuration</label>
            <div class="ml-2" x-show="hasChanges" x-cloak>
                <span class="badge badge-primary badge-sm changed-badge">
                    <span class="text-xs mb-0.5">changed</span>
                </span>
            </div>
        </div>
        <p class="text-sm text-gray-500">Set custom confidence thresholds for specific species.</p>
    </div>
    <div class="collapse-content">
        <!-- Custom configuration list and input -->
        <div class="form-control relative mt-4">
            <label class="label-text">
                Custom Species Configuration
                <span class="ml-2 text-sm text-gray-500 cursor-help"
                      @mouseenter="showTooltip = 'customConfig'"
                      @mouseleave="showTooltip = null">ⓘ</span>
            </label>

            <div class="absolute left-0 bottom-full mb-2 p-2 bg-gray-100 text-sm rounded shadow-md z-50"
                 x-show="showTooltip === 'customConfig'" x-cloak>
                Set custom confidence thresholds for specific species. These will override the global threshold for the specified species.
            </div>

            <!-- Custom configuration list -->
            <div class="space-y-2">
                <!-- Header -->
                <div class="flex bg-gray-100 p-2 rounded-md">
                    <div class="flex-grow text-sm font-medium">Species</div>
                    <div class="w-24 text-sm font-medium">Threshold</div>
                    <div class="w-20 text-sm font-medium text-center">Actions</div>
                    <div class="w-20 text-sm font-medium text-center"></div>
                </div>
                
                <!-- List items -->
                <template x-for="(config, species) in speciesSettings.Config" :key="species">
                    <div class="flex items-center bg-gray-50 p-2 rounded-md">
                        <div class="flex-grow text-sm pl-2" x-text="species"></div>
                        <div class="w-24 text-sm px-3" x-text="config.Threshold.toFixed(2)"></div>
                        <div class="w-20 text-center">
                            <button type="button" 
                                    @click.prevent="openActionsModal(species)" 
                                    class="btn btn-xs">
                                <span x-text="config.Actions?.length ? 'Edit Action' : 'Add Action'"></span>
                            </button>
                        </div>
                        <div class="w-20 text-center">
                            <button type="button" 
                                    @click="removeConfig(species)" 
                                    class="btn btn-xs">Remove</button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Custom configuration input -->
            <div class="flex items-center mt-2">
                <input type="text" 
                       x-model="newSpeciesConfig" 
                       @input="updatePredictions(newSpeciesConfig)" 
                       list="species-suggestions"
                       placeholder="Species" 
                       class="input input-bordered input-sm flex-grow" />
                <datalist id="species-suggestions">
                    <template x-for="species in predictions" :key="species">
                        <option :value="species"></option>
                    </template>
                </datalist>
                <input type="number" 
                       x-model.number="newThreshold" 
                       class="input input-bordered input-sm w-24 ml-2" 
                       min="0" 
                       max="1" 
                       step="0.01" 
                       placeholder="Threshold" />
                
                <button type="button" @click="openActionsModal(newSpeciesConfig)" 
                        class="btn btn-sm ml-2">Actions</button>
                <button type="button" @click="addConfig()" class="btn btn-sm btn-primary ml-2 w-20">Add</button>
            </div>
        </div>

        <!-- Actions Modal -->
        <div x-show="showActionsModal" 
             class="modal modal-open" 
             x-cloak>
            <div class="modal-box bg-base-100">
                <h3 class="text-lg font-bold mb-4" x-text="'Actions for ' + currentSpecies"></h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium">Action Type</label>
                    <select x-model="currentAction.type" 
                            class="select select-bordered w-full mt-1" 
                            disabled>
                        <option value="ExecuteCommand">Execute Command</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium">Command</label>
                    <input type="text" 
                           x-model="currentAction.command" 
                           class="input input-bordered w-full mt-1" 
                           placeholder="/path/to/your/command">
                    <p class="text-sm text-gray-500 mt-1">Provide the full path to the command you want to execute</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium">Parameters</label>
                    <input type="text" 
                           x-model="currentAction.parameters" 
                           class="input input-bordered w-full mt-1" 
                           placeholder="Parameters will appear here"
                           readonly>
                    <p class="text-sm text-gray-500 mt-1">Click parameters below to add them to your command</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium">Available Parameters</label>
                    <p class="text-sm text-gray-500 mb-2">Click to add parameters to your script:</p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" 
                                @click.prevent="currentAction.parameters = currentAction.parameters ? currentAction.parameters + ',CommonName' : 'CommonName'" 
                                class="btn btn-xs">CommonName</button>
                        <button type="button" 
                                @click.prevent="currentAction.parameters = currentAction.parameters ? currentAction.parameters + ',ScientificName' : 'ScientificName'" 
                                class="btn btn-xs">ScientificName</button>
                        <button type="button" 
                                @click.prevent="currentAction.parameters = currentAction.parameters ? currentAction.parameters + ',Confidence' : 'Confidence'" 
                                class="btn btn-xs">Confidence</button>
                        <button type="button" 
                                @click.prevent="currentAction.parameters = currentAction.parameters ? currentAction.parameters + ',Time' : 'Time'" 
                                class="btn btn-xs">Time</button>
                        <button type="button" 
                                @click.prevent="currentAction.parameters = currentAction.parameters ? currentAction.parameters + ',Source' : 'Source'" 
                                class="btn btn-xs">Source</button>
                    </div>
                    <div class="mt-2">
                        <button type="button" 
                                @click.prevent="currentAction.parameters = ''" 
                                class="btn btn-xs btn-warning">Clear Parameters</button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Parameters will be passed to your script in the order they are added</p>
                </div>
                
                <div class="modal-action">
                    <button type="button" 
                            @click.prevent="saveAction()" 
                            class="btn btn-primary">Save</button>
                    <button type="button" 
                            @click.prevent="closeActionsModal()" 
                            class="btn">Cancel</button>
                </div>
            </div>
            <div class="modal-backdrop" @click="closeActionsModal()"></div>
        </div>

        <!-- Hidden inputs to always submit the species settings -->
        <input type="hidden" name="realtime.species.include" :value="JSON.stringify(speciesSettings.Include || [])">
        <input type="hidden" name="realtime.species.exclude" :value="JSON.stringify(speciesSettings.Exclude || [])">
        <input type="hidden" name="realtime.species.config" :value="JSON.stringify(speciesSettings.Config || {})">
    </div>
</div>

{{end}}